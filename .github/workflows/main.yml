name: Deploy Portfolio to EC2

on:
  push:
    branches:
      - main   # Change to your default branch if different (e.g. master)

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout code ──────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Deploy via SSH ─────────────────────────────────────────────────
      #    Connects to your EC2 instance and pulls + serves the latest files.
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:       ${{ secrets.EC2_HOST }}       # e.g. 13.233.x.x
          username:   ${{ secrets.EC2_USER }}       # e.g. ubuntu, ec2-user
          key:        ${{ secrets.EC2_SSH_KEY }}    # Contents of your .pem private key
          port:       22
          script: |
            # ── Update system packages (optional, safe to remove) ──────────
            # sudo apt-get update -y

            # ── Ensure Nginx is installed ──────────────────────────────────
            if ! command -v nginx &> /dev/null; then
              sudo apt-get update -y
              sudo apt-get install -y nginx
            fi

            # ── Ensure Git is installed ────────────────────────────────────
            if ! command -v git &> /dev/null; then
              sudo apt-get install -y git
            fi

            # ── Clone repo on first deploy, or pull latest changes ─────────
            REPO_DIR="/var/www/portfolio"

            if [ -d "$REPO_DIR/.git" ]; then
              echo "Repository exists — pulling latest changes..."
              cd "$REPO_DIR"
              git pull origin main
            else
              echo "Repository not found — cloning fresh..."
              sudo mkdir -p "$REPO_DIR"
              sudo chown $USER:$USER "$REPO_DIR"
              git clone https://github.com/${{ secrets.GH_REPO }}.git "$REPO_DIR"
              # ↑ Add GH_REPO secret as  owner/repo-name  (e.g. gaurav69-ux/portfolio)
            fi

            # ── Set correct permissions for Nginx ─────────────────────────
            sudo chown -R www-data:www-data "$REPO_DIR"
            sudo chmod -R 755 "$REPO_DIR"

            # ── Write Nginx site config (idempotent) ──────────────────────
            NGINX_CONF="/etc/nginx/sites-available/portfolio"

            sudo tee "$NGINX_CONF" > /dev/null <<'EOF'
            server {
                listen 80;
                server_name _;          # Replace _ with your domain if you have one

                root /var/www/portfolio;
                index index.html;

                # Handle client-side routing (no 404 on direct URL access)
                location / {
                    try_files $uri $uri/ /index.html;
                }

                # Cache static assets aggressively
                location ~* \.(css|js|webp|png|jpg|jpeg|gif|ico|svg|woff2?)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }

                # Disable caching for HTML
                location ~* \.html$ {
                    expires -1;
                    add_header Cache-Control "no-cache, no-store, must-revalidate";
                }
            }
            EOF

            # ── Enable site & remove default if present ────────────────────
            sudo ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/portfolio
            sudo rm -f /etc/nginx/sites-enabled/default

            # ── Test config and reload Nginx ───────────────────────────────
            sudo nginx -t && sudo systemctl reload nginx

            echo "✅ Deployment complete!"
